# 実装計画書

提示された資料（MVP仕様、最終設計、ギャップ分析）に基づき、MVPから完成形へ移行するための**優先度付きTo-Doリスト**を作成しました。

**ランク付けの基準:**

1. **Core (核)**: データ構造や解析ロジックの根幹に関わるもの（後で変更すると手戻りが大きい）。
2. **Infra (基盤)**: 複数人利用や本番運用に必須なもの。
3. **Exp (体験)**: UIや利便性向上、付加機能。

---

### Phase 1: データ構造と解析の深化 (The Core)

**理由:** 「単なる要約」から「研究室のナレッジベース」へ進化させるための最も重要なステップです。データスキーマとRAG基盤がないと、高機能なUIを作っても意味がありません。

### 1-1. データベース・スキーマの刷新

- [x]  **MVP:** 基本テーブル作成 (`users`, `papers`, `tasks`)
- [ ]  **Todo:** `pgvector` 拡張機能のインストールと有効化
- [ ]  **Todo:** 正規化テーブルへのマイグレーション実行（`versions`, `files`, `authors`, `embeddings` 等の作成）
- [ ]  **Todo:** Alembicによる自動マイグレーション設定

### 1-2. パース処理の高度化 (Parser)

- [x]  **MVP:** PDFからのプレーンテキスト抽出 (`pypdf`等)
- [ ]  **Todo:** テキスト抽出ロジックの置換（Markdown構造化、章ごとのチャンク分割）
- [ ]  **Todo:** 座標データ (`bbox`) の抽出とDB保存ロジックの実装（※ハイライト機能の準備）
- [ ]  **Todo:** ZIP解凍機能とディレクトリ走査の実装
- [ ]  **Todo:** TeXファイルのメインファイル特定ロジックの実装

### 1-3. RAGパイプラインの構築 (Worker)

- [x]  **MVP:** テキストをそのままLLMへ渡す
- [ ]  **Todo:** Embedding生成処理の実装（抽出テキストをベクトル化してDB保存）
- [ ]  **Todo:** 検索ロジックの実装（コサイン類似度で過去論文・学会ルールを検索）
- [ ]  **Todo:** プロンプトエンジニアリング（検索結果をコンテキストとして注入する処理）

---

### Phase 2: インフラと堅牢性の確保 (The Infra)

**理由:** 実際の学生・教授が利用する環境（Google認証、Drive保存）を整え、システムの安定性を確保します。

### 2-1. 認証と権限管理

- [x]  **MVP:** 固定デモユーザー (`id=1`)
- [ ]  **Todo:** Google OAuth2 認証フローの実装
- [ ]  **Todo:** ドメイン制限 (`@ed.waseda.jp`) とユーザー登録ロジックの実装
- [ ]  **Todo:** ロール自動割り当て（Admin/Professor/Student）の実装

### 2-2. 外部ストレージ連携

- [x]  **MVP:** ローカルDocker Volumeへの保存
- [ ]  **Todo:** Google Drive APIクライアントの実装（アップロード/ダウンロード）
- [ ]  **Todo:** 非同期アップロード処理（ユーザーを待たせないためのキューイング）
- [ ]  **Todo:** キャッシュ管理ロジック（ローカル容量監視と古いファイルの削除）

### 2-3. タスク制御の堅牢化

- [x]  **MVP:** エラー時は即終了、リトライなし
- [ ]  **Todo:** Worker内でのタイムアウト設定（例: 10分）
- [ ]  **Todo:** エラー時の自動リトライ処理（最大3回）の実装
- [ ]  **Todo:** ゾンビタスク監視（Watcher）の実装

---

### Phase 3: ユーザー体験と高度な機能 (The Experience)

**理由:** 基盤が整った上で、ユーザーにとっての「使いやすさ」や「リッチな機能」を実装します。

### 3-1. リアルタイム通信とUI連携

- [x]  **MVP:** ポーリング (3秒間隔)
- [ ]  **Todo:** SSEサーバー（Backend）の実装
- [ ]  **Todo:** SSEクライアント（Frontend）と通知トレイの実装
- [ ]  **Todo:** 詳細進捗バー（解析フェーズの可視化）の実装

### 3-2. フィードバック詳細画面の拡張

- [x]  **MVP:** Markdownテキストの表示のみ
- [ ]  **Todo:** PDFプレビューアの実装
- [ ]  **Todo:** AI指摘箇所のハイライト表示（Phase 1-2の座標データを利用）
- [ ]  **Todo:** レーダーチャート（スコア）の実装
- [ ]  **Todo:** バージョン間差分 (Diff) の表示タブ実装

### 3-3. 管理機能とライブラリ

- [ ]  **Todo:** 研究室ライブラリ画面（検索・一覧）の作成
- [ ]  **Todo:** セマンティック検索（自然言語検索）UIの実装
- [ ]  **Todo:** 管理画面（ユーザー管理、システムモニタ）の作成
- [ ]  **Todo:** 学会ルールエディタ（JSON編集GUI）の実装

---

### 開発者へのアドバイス

まず **Phase 1（データ構造と解析）** を完了させないと、アプリの見た目はリッチになっても「中身（AIの精度）」がMVPと同じままになってしまいます。

特に `pgvector` の導入と `Parser` の高度化は、後から変更するとデータベースの中身を全て作り直すことになるため、最優先で取り組んでください。